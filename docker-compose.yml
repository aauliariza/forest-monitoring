version: '3.8'

services:
  # 1. Broker MQTT (Middleware)
  broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "1883:1883"  # Port MQTT standar
      - "9001:9001"  # Port MQTT via WebSocket
    volumes:
      - ./broker_config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    networks:
      - forest-network
    restart: unless-stopped

  # 2. Database PostgreSQL (Penyimpanan)
  db:
    image: postgres:14
    container_name: postgres-db
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: forest_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - forest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d forest_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Dashboard Service (Backend API + Subscriber)
  dashboard_service:
    build:
      context: ./dashboard_service
      dockerfile: Dockerfile
    container_name: dashboard-service
    ports:
      - "8000:80"  # API accessible on port 8000
    depends_on:
      db:
        condition: service_healthy
      broker:
        condition: service_started
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql://admin:password123@db:5432/forest_db"
      MQTT_BROKER_HOST: "broker"
      MQTT_BROKER_PORT: "1883"
    networks:
      - forest-network
    restart: unless-stopped

  # 4. Sensor Nodes (Publishers)
  # Sensor Node 1 - Temperature Sensor
  sensor_temperature:
    build:
      context: ./sensor_node
      dockerfile: Dockerfile
    container_name: sensor-temperature
    depends_on:
      - broker
    environment:
      MQTT_BROKER_HOST: "broker"
      SENSOR_ID: "temp-01"
      SENSOR_TYPE: "temperature"
      LOCATION: "Hutan Lindung Area 1"
      SAMPLE_INTERVAL: "10"
    networks:
      - forest-network
    restart: unless-stopped

  # Sensor Node 2 - Humidity Sensor
  sensor_humidity:
    build:
      context: ./sensor_node
      dockerfile: Dockerfile
    container_name: sensor-humidity
    depends_on:
      - broker
    environment:
      MQTT_BROKER_HOST: "broker"
      SENSOR_ID: "hum-01"
      SENSOR_TYPE: "humidity"
      LOCATION: "Hutan Lindung Area 1"
      SAMPLE_INTERVAL: "10"
    networks:
      - forest-network
    restart: unless-stopped

  # Sensor Node 3 - Smoke Sensor
  sensor_smoke:
    build:
      context: ./sensor_node
      dockerfile: Dockerfile
    container_name: sensor-smoke
    depends_on:
      - broker
    environment:
      MQTT_BROKER_HOST: "broker"
      SENSOR_ID: "smoke-01"
      SENSOR_TYPE: "smoke"
      LOCATION: "Hutan Lindung Area 1"
      SAMPLE_INTERVAL: "10"
    networks:
      - forest-network
    restart: unless-stopped

  # 5. Web Dashboard (Frontend)
  web_dashboard:
    build:
      context: ./web_dashboard
      dockerfile: Dockerfile
    container_name: web-dashboard
    ports:
      - "3000:80"  # Dashboard accessible on port 3000
    depends_on:
      - dashboard_service
    networks:
      - forest-network
    restart: unless-stopped

# Networks
networks:
  forest-network:
    driver: bridge

# Volumes
volumes:
  postgres_data:
    driver: local